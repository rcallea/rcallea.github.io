<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Flipbook PDF - Doble p√°gina</title>

  <!-- PDF.js (versi√≥n cl√°sica estable) -->
  <script src="libs/pdfjs/pdf.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .flipbook-container {
      width: 100%;
      max-width: 1100px;
      margin: 1rem;
      background: #020617;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #1f2937;
    }

    .flipbook-header {
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .flipbook-title {
      font-size: 0.95rem;
      font-weight: 500;
      color: #f9fafb;
      white-space: nowrap;
    }

    .flipbook-file-input label {
      font-size: 0.8rem;
      background: #111827;
      color: #e5e7eb;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #374151;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, transform 0.1s;
    }

    .flipbook-file-input label:hover {
      background: #1f2937;
      border-color: #facc15;
    }

    .flipbook-file-input input {
      display: none;
    }

    .flipbook-viewer {
      position: relative;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 50%, #020617 100%);
      padding: 1.25rem;
    }

    .page-wrapper {
      position: relative;
      margin: 0 auto;
      max-width: 100%;
      perspective: 1600px;
    }

    .page-spread {
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 0; /* pegadas, sin hueco ni solapamiento */
    }

    .page {
      flex: 1 1 50%;
      max-width: 50%;
      padding: 0; /* sin padding para que se junten justo al centro */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .page-inner {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .page-left {
      border-right: 2px solid #020617; /* ‚Äúlomo‚Äù del libro */
    }

    .page-right {
      border-left: 2px solid #020617;
    }

    canvas {
      display: block;
      width: 100%;   /* responsive */
      height: auto;  /* mantiene proporci√≥n */
      background: #111827;
      border-radius: 0;           /* sin bordes redondeados para que no se vea montado */
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }

    /* Capa para enlaces sobre el canvas */
    .link-layer {
      position: absolute;
      inset: 0;
      pointer-events: none; /* solo los enlaces recibir√°n eventos */
    }

    .pdf-link {
      position: absolute;
      display: block;
      pointer-events: auto;
      text-decoration: none;
    }

    .pdf-link:hover {
      outline: 2px solid rgba(250, 204, 21, 0.6); /* amarillo suave para depurar / feedback */
    }

    /* Efecto de ‚Äúpasar p√°gina‚Äù en doble p√°gina */
    .page-wrapper.flip-next {
      animation: flipNext 0.55s ease-out;
    }

    .page-wrapper.flip-prev {
      animation: flipPrev 0.55s ease-out;
    }

    @keyframes flipNext {
      0%   { transform: rotateY(0deg); }
      40%  { transform: rotateY(-16deg) translateX(-8px); }
      100% { transform: rotateY(0deg); }
    }

    @keyframes flipPrev {
      0%   { transform: rotateY(0deg); }
      40%  { transform: rotateY(16deg) translateX(8px); }
      100% { transform: rotateY(0deg); }
    }

    .flipbook-controls {
      padding: 0.75rem 1rem 1rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      background: #020617;
    }

    .button-group {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    button.flip-btn {
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      font-size: 0.8rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: background 0.2s, border-color 0.2s, transform 0.05s;
    }

    button.flip-btn:hover {
      background: #1f2937;
      border-color: #facc15;
    }

    button.flip-btn:active {
      transform: translateY(1px);
    }

    button.flip-btn:disabled {
      opacity: 0.35;
      cursor: default;
      border-color: #111827;
    }

    .page-info {
      font-size: 0.8rem;
      color: #9ca3af;
      white-space: nowrap;
    }

    .zoom-info {
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: right;
      min-width: 70px;
    }

    @media (max-width: 768px) {
      .flipbook-viewer {
        padding: 0.8rem;
      }
      .page-spread {
        flex-direction: column; /* en m√≥vil, una p√°gina debajo de la otra */
      }
      .page {
        max-width: 100%;
      }
      .page-left,
      .page-right {
        border: none;
      }
    }

    @media (max-width: 640px) {
      .flipbook-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .flipbook-title {
        font-size: 0.85rem;
      }
      .flipbook-controls {
        padding: 0.6rem 0.8rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="flipbook-container">
    <header class="flipbook-header">
      <div class="flipbook-title">
        üìñ Flipbook PDF doble p√°gina (HTML, CSS, JS)
      </div>
      <div class="flipbook-file-input">
        <label>
          üìÇ Cargar PDF‚Ä¶
          <input type="file" id="fileInput" accept="application/pdf" />
        </label>
      </div>
    </header>

    <main class="flipbook-viewer">
      <div class="page-wrapper" id="pageWrapper">
        <div class="page-spread">
          <div class="page page-left">
            <div class="page-inner">
              <canvas id="leftCanvas"></canvas>
              <div class="link-layer" id="leftLinks"></div>
            </div>
          </div>
          <div class="page page-right">
            <div class="page-inner">
              <canvas id="rightCanvas"></canvas>
              <div class="link-layer" id="rightLinks"></div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="flipbook-controls">
      <div class="button-group">
        <button class="flip-btn" id="prevPageBtn">
          ‚¨ÖÔ∏è Anterior
        </button>
        <button class="flip-btn" id="nextPageBtn">
          Siguiente ‚û°Ô∏è
        </button>
        <span class="page-info" id="pageInfo">
          P√°gina - / -
        </span>
      </div>

      <div class="button-group">
        <button class="flip-btn" id="zoomOutBtn">‚ûñ Zoom</button>
        <button class="flip-btn" id="zoomResetBtn">üîÑ 100%</button>
        <button class="flip-btn" id="zoomInBtn">‚ûï Zoom</button>
        <span class="zoom-info" id="zoomInfo">100%</span>
      </div>
    </footer>
  </div>

  <script>
    // Compatibilidad con PDF.js
    var pdfjsLib = window["pdfjsLib"] || window["pdfjs-dist/build/pdf"];

    if (!pdfjsLib) {
      console.error("No se pudo encontrar pdfjsLib. Revisa la URL del script de PDF.js.");
    } else {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "libs/pdfjs/pdf.worker.js";
    }

    // -------- CONFIGURACI√ìN B√ÅSICA --------
    // PDF por defecto:
    const DEFAULT_PDF_URL = "libro.pdf";

    const leftCanvas = document.getElementById("leftCanvas");
    const rightCanvas = document.getElementById("rightCanvas");
    const leftCtx = leftCanvas.getContext("2d");
    const rightCtx = rightCanvas.getContext("2d");
    const pageWrapper = document.getElementById("pageWrapper");

    const leftLinks = document.getElementById("leftLinks");
    const rightLinks = document.getElementById("rightLinks");

    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const zoomResetBtn = document.getElementById("zoomResetBtn");
    const pageInfo = document.getElementById("pageInfo");
    const zoomInfo = document.getElementById("zoomInfo");
    const fileInput = document.getElementById("fileInput");

    let pdfDoc = null;
    let totalPages = 0;

    // Spreads: [{left, right}, ...]
    // Primer spread: {left: null, right: 1} (portada a la derecha)
    let spreads = [];
    let currentSpreadIndex = 0;

    // Zoom
    let baseScale = 1.0;
    let currentScale = 1.0;
    const minScale = 0.5;
    const maxScale = 3.0;
    const zoomStep = 0.2;

    let pageRendering = false;
    let pendingSpreadIndex = null;

    // -------- AYUDAS PARA SPREADS --------
    function buildSpreads(numPages) {
      const result = [];
      // Primer spread: solo p√°gina 1 a la derecha
      result.push({ left: null, right: 1 });
      // Luego spreads de dos p√°ginas: (2,3), (4,5), ...
      for (let p = 2; p <= numPages; p += 2) {
        const left = p;
        const right = p + 1 <= numPages ? p + 1 : null;
        result.push({ left, right });
      }
      return result;
    }

    // -------- RENDERIZADO DE UNA P√ÅGINA (CANVAS + ENLACES) --------
    function renderPageToCanvas(pageNum, canvas, ctx, linkLayer) {
      if (!pageNum) {
        // No hay p√°gina; se limpia
        linkLayer.innerHTML = "";
        const blankWidth = 800;
        const blankHeight = 1000;
        canvas.width = blankWidth;
        canvas.height = blankHeight;
        canvas.style.width = "100%";
        canvas.style.height = "auto";
        ctx.clearRect(0, 0, blankWidth, blankHeight);
        return Promise.resolve();
      }

      return pdfDoc.getPage(pageNum).then(function (page) {
        const viewport = page.getViewport({ scale: currentScale });
        const outputScale = window.devicePixelRatio || 1;

        canvas.width = Math.floor(viewport.width * outputScale);
        canvas.height = Math.floor(viewport.height * outputScale);

        // Responsive: el canvas siempre ocupa el ancho disponible
        canvas.style.width = "100%";
        canvas.style.height = "auto";

        const transform = outputScale !== 1
          ? [outputScale, 0, 0, outputScale, 0, 0]
          : null;

        linkLayer.innerHTML = "";

        const renderTask = page.render({
          canvasContext: ctx,
          viewport: viewport,
          transform: transform
        });

        // Cuando termina el render, creamos la capa de enlaces
        return renderTask.promise.then(function () {
          return page.getAnnotations();
        }).then(function (annots) {
          annots.forEach(function (a) {
            if (a.subtype === "Link" && a.rect) {
              // S√≥lo manejamos enlaces externos (URL) aqu√≠
              if (!a.url) return;

              const rect = a.rect;
              const x1 = Math.min(rect[0], rect[2]);
              const y1 = Math.min(rect[1], rect[3]); // lower-left y
              const x2 = Math.max(rect[0], rect[2]);
              const y2 = Math.max(rect[1], rect[3]); // upper-right y

              const rectWidth = x2 - x1;
              const rectHeight = y2 - y1;

              // PDF usa origen en la esquina inferior izquierda
              // CSS usa origen en la esquina superior izquierda
              const leftPct = (x1 / viewport.width) * 100;
              const widthPct = (rectWidth / viewport.width) * 100;
              const bottomFromBottom = y1;
              const topFromTop = viewport.height - bottomFromBottom - rectHeight;
              const topPct = (topFromTop / viewport.height) * 100;
              const heightPct = (rectHeight / viewport.height) * 100;

              const linkEl = document.createElement("a");
              linkEl.href = a.url;
              linkEl.target = "_blank";
              linkEl.className = "pdf-link";
              linkEl.style.left = leftPct + "%";
              linkEl.style.top = topPct + "%";
              linkEl.style.width = widthPct + "%";
              linkEl.style.height = heightPct + "%";

              linkLayer.appendChild(linkEl);
            }
          });
        });
      });
    }

    // -------- RENDERIZADO DE DOBLE P√ÅGINA --------
    function renderSpread(spreadIndex, flipDirection) {
      if (!pdfDoc || !spreads.length) return;
      const spread = spreads[spreadIndex];
      const leftPageNum = spread.left;
      const rightPageNum = spread.right;

      pageRendering = true;

      // Animaci√≥n de pasar p√°gina
      if (flipDirection === "next") {
        pageWrapper.classList.remove("flip-prev");
        void pageWrapper.offsetWidth; // reinicia animaci√≥n
        pageWrapper.classList.add("flip-next");
      } else if (flipDirection === "prev") {
        pageWrapper.classList.remove("flip-next");
        void pageWrapper.offsetWidth;
        pageWrapper.classList.add("flip-prev");
      }

      const tasks = [];
      tasks.push(
        renderPageToCanvas(leftPageNum, leftCanvas, leftCtx, leftLinks)
      );
      tasks.push(
        renderPageToCanvas(rightPageNum, rightCanvas, rightCtx, rightLinks)
      );

      Promise.all(tasks)
        .then(function () {
          pageRendering = false;
          updatePageInfo();
          if (pendingSpreadIndex !== null) {
            const nextIndex = pendingSpreadIndex;
            pendingSpreadIndex = null;
            renderSpread(
              nextIndex,
              nextIndex > spreadIndex ? "next" : "prev"
            );
          }
        })
        .catch(function (err) {
          console.error("Error renderizando spread:", err);
          pageRendering = false;
        });
    }

    function queueRenderSpread(spreadIndex, flipDirection) {
      if (pageRendering) {
        pendingSpreadIndex = spreadIndex;
      } else {
        renderSpread(spreadIndex, flipDirection);
      }
    }

    // -------- NAVEGACI√ìN --------
    function onPrevSpread() {
      if (!pdfDoc || currentSpreadIndex <= 0) return;
      currentSpreadIndex--;
      queueRenderSpread(currentSpreadIndex, "prev");
      updateButtons();
    }

    function onNextSpread() {
      if (!pdfDoc || currentSpreadIndex >= spreads.length - 1) return;
      currentSpreadIndex++;
      queueRenderSpread(currentSpreadIndex, "next");
      updateButtons();
    }

    // -------- ZOOM --------
    function updateZoomDisplay() {
      zoomInfo.textContent = `${Math.round(currentScale * 100)}%`;
    }

    function setZoom(newScale) {
      if (!pdfDoc) return;
      currentScale = Math.min(maxScale, Math.max(minScale, newScale));
      updateZoomDisplay();
      queueRenderSpread(currentSpreadIndex); // re-render sin anim extra
    }

    function onZoomIn() {
      setZoom(currentScale + zoomStep);
    }

    function onZoomOut() {
      setZoom(currentScale - zoomStep);
    }

    function onZoomReset() {
      setZoom(baseScale);
    }

    // -------- CARGA DE PDF --------
    function loadPdfFromUrl(url) {
      if (!pdfjsLib || !url) return;

      const loadingTask = pdfjsLib.getDocument(url);
      loadingTask.promise.then(function (pdf) {
        pdfDoc = pdf;
        totalPages = pdf.numPages;
        spreads = buildSpreads(totalPages);
        currentSpreadIndex = 0;
        baseScale = 1.0;
        currentScale = baseScale;
        updateButtons();
        updateZoomDisplay();
        renderSpread(currentSpreadIndex);
      }).catch(function (err) {
        console.error("Error cargando PDF:", err);
        alert("No se pudo cargar el PDF. Revisa la ruta o el CORS.");
      });
    }

    function loadPdfFromFile(file) {
      if (!pdfjsLib || !file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const typedArray = new Uint8Array(e.target.result);
        const loadingTask = pdfjsLib.getDocument({ data: typedArray });

        loadingTask.promise.then(function (pdf) {
          pdfDoc = pdf;
          totalPages = pdf.numPages;
          spreads = buildSpreads(totalPages);
          currentSpreadIndex = 0;
          baseScale = 1.0;
          currentScale = baseScale;
          updateButtons();
          updateZoomDisplay();
          renderSpread(currentSpreadIndex);
        }).catch(function (err) {
          console.error("Error cargando PDF desde archivo:", err);
          alert("No se pudo leer el archivo PDF.");
        });
      };
      reader.readAsArrayBuffer(file);
    }

    // -------- UI --------
    function updateButtons() {
      prevPageBtn.disabled = !pdfDoc || currentSpreadIndex <= 0;
      nextPageBtn.disabled = !pdfDoc || currentSpreadIndex >= spreads.length - 1;
      if (!pdfDoc) {
        pageInfo.textContent = "P√°gina - / -";
      }
    }

    function updatePageInfo() {
      if (!pdfDoc || !spreads.length) {
        pageInfo.textContent = "P√°gina - / -";
        return;
      }
      const spread = spreads[currentSpreadIndex];
      const left = spread.left;
      const right = spread.right;

      if (left && right) {
        pageInfo.textContent = `P√°ginas ${left}‚Äì${right} de ${totalPages}`;
      } else if (right && !left) {
        pageInfo.textContent = `P√°gina ${right} de ${totalPages}`;
      } else if (left && !right) {
        pageInfo.textContent = `P√°gina ${left} de ${totalPages}`;
      } else {
        pageInfo.textContent = `P√°gina - / ${totalPages}`;
      }
    }

    // Eventos botones
    prevPageBtn.addEventListener("click", onPrevSpread);
    nextPageBtn.addEventListener("click", onNextSpread);
    zoomInBtn.addEventListener("click", onZoomIn);
    zoomOutBtn.addEventListener("click", onZoomOut);
    zoomResetBtn.addEventListener("click", onZoomReset);

    // Cambio de archivo
    fileInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file) {
        loadPdfFromFile(file);
      }
    });

    // Navegaci√≥n con teclado
    document.addEventListener("keydown", function (e) {
      if (e.key === "ArrowRight") {
        onNextSpread();
      } else if (e.key === "ArrowLeft") {
        onPrevSpread();
      } else if ((e.ctrlKey || e.metaKey) && e.key === "+") {
        e.preventDefault();
        onZoomIn();
      } else if ((e.ctrlKey || e.metaKey) && e.key === "-") {
        e.preventDefault();
        onZoomOut();
      }
    });

    // Carga inicial desde URL por defecto
    if (DEFAULT_PDF_URL && pdfjsLib) {
      loadPdfFromUrl(DEFAULT_PDF_URL);
    } else {
      updateButtons();
    }
  </script>
</body>
</html>
